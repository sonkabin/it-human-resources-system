<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>IT企业人力资源管理系统</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="robots" content="all,follow">
    <!-- Bootstrap CSS-->
    <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css"
          th:href="@{/vendor/bootstrap/css/bootstrap.min.css}">
    <!-- Font Awesome CSS-->
    <link rel="stylesheet" href="vendor/font-awesome/css/font-awesome.min.css"
          th:href="@{/vendor/font-awesome/css/font-awesome.min.css}">
    <!-- Fontastic Custom icon font-->
    <link rel="stylesheet" href="css/fontastic.css" th:href="@{/css/fontastic.css}">
    <!-- Google fonts - Poppins -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:300,400,700">
    <!-- theme stylesheet-->
    <link rel="stylesheet" href="css/style.default.css" id="theme-stylesheet" th:href="@{/css/style.default.css}">
    <!-- Custom stylesheet - for your changes-->
    <link rel="stylesheet" href="css/custom.css" th:href="@{/css/custom.css}">
    <link rel="stylesheet" href="css/bootstrap-table.min.css" th:href="@{/css/bootstrap-table.min.css}">
    <link rel="stylesheet" href="css/bootstrap-datetimepicker.min.css" th:href="@{/css/bootstrap-datetimepicker.min.css}">
    <link rel="stylesheet" href="css/toastr.min.css" th:href="@{/css/toastr.min.css}">
</head>
<body>


<div class="page">
    <!-- 引入抽取的topbar -->
    <div th:replace="~{commons/bar::topbar}"></div>

    <div class="page-content d-flex align-items-stretch">
        <!-- 引入抽取的sidebar -->
        <div th:replace="~{commons/bar::employee-sidebar(activeUrl='person.html')}"></div>
        <div class="content-inner">
            <!-- Page Header-->
            <header class="page-header">
                <div class="container-fluid">
                    <h2 class="no-margin-bottom">Dashboard</h2>
                </div>
            </header>
            <!-- Breadcrumb-->
            <div class="breadcrumb-holder container-fluid">
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/employee.html">主页</a></li>
                    <li class="breadcrumb-item"><a href="/project.html">项目管理</a></li>
                    <li class="breadcrumb-item active">成员调动</li>
                </ul>
            </div>

            <section class="tables">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header d-flex align-items-center">
                                    <button class="btn btn-success" id="require-btn">申请成员</button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>成员名</th>
                                                    <th>工作时间比例</th>
                                                    <th>创建时间</th>
                                                    <th>修改时间</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="config:${info.humanConfigs}" th:if="${config.empId} != ${session.loginEmp.id}">
                                                    <input name="empId" type="hidden" th:value="${config.empId}">
                                                    <td th:text="${config.empName}"></td>
                                                    <td th:text="${config.portion}"></td>
                                                    <td th:text="${#temporals.format(config.gmtCreate,'yyyy-MM-dd HH:mm:ss')}"></td>
                                                    <td th:text="${#temporals.format(config.gmtModified,'yyyy-MM-dd HH:mm:ss')}"></td>
                                                    <td>
                                                        <button class="btn btn-sm btn-info skill-btn" th:attr="emp-id=${config.empId}">技能详情</button>
                                                        <button class="btn btn-sm btn-primary release-btn">释放成员</button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <input type="hidden" id="project-id" th:value="${info.humanConfigs[0].projectId}">
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 申请成员模态框 -->
            <div id="requireModal" data-backdrop="static" tabindex="-1" role="dialog" aria-hidden="true" class="modal fade text-left">
                <div role="document" class="modal-dialog  modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">申请成员</h4>
                            <button type="button" data-dismiss="modal" aria-label="Close" class="close"><span
                                    aria-hidden="true">×</span></button>
                        </div>
                        <div class="modal-body">
                            <form class="form-horizontal" id="require-form">
                                <div class="col-sm-11">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>成员名</th>
                                            <th>可分配工作时间比例</th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        <tbody id="require-tbody"></tbody>
                                    </table>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-sm btn-success" id="save-huamns">加入项目组</button>
                            <button type="button" data-dismiss="modal" class="btn btn-secondary">关闭</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 技能详情模态框-->
            <div id="myModal" data-backdrop="static" tabindex="-1" role="dialog" aria-hidden="true" class="modal fade text-left">
                <div role="document" class="modal-dialog  modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">技能详情</h4>
                            <button type="button" data-dismiss="modal" aria-label="Close" class="close"><span
                                    aria-hidden="true">×</span></button>
                        </div>
                        <div class="modal-body">
                            <form class="form-horizontal">
                                <div class="col-sm-11">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                        <tr>
                                            <th>技能名</th>
                                            <th>等级</th>
                                        </tr>
                                        </thead>
                                        <tbody id="skills">
                                        </tbody>
                                    </table>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" data-dismiss="modal" class="btn btn-secondary">关闭</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 释放成员模态框 -->
            <div id="releaseModal" data-backdrop="static" tabindex="-1" role="dialog" aria-hidden="true" class="modal fade text-left">
                <div role="document" class="modal-dialog  modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" >释放成员</h4>
                            <button type="button" data-dismiss="modal" aria-label="Close" class="close"><span
                                    aria-hidden="true">×</span></button>
                        </div>
                        <div class="modal-body">
                            <form class="form-horizontal" id="release-form">
                                <input type="hidden" name="empId" id="empId">
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label">成员名</label>
                                    <input name="empName" type="text" class="form-control-plaintext col-sm-8" readonly>
                                </div>
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label">成员贡献</label>
                                    <textarea rows="3" name="contribute" type="text" class="form-control col-sm-8"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary save-btn">确定释放</button>
                            <button type="button" data-dismiss="modal" class="btn btn-secondary">关闭</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- 引入footer -->
            <div th:replace="~{commons/bar::footer}" }></div>
        </div>
    </div>
</div>
<!-- JavaScript files-->
<script src="vendor/jquery/jquery.min.js" th:src="@{/vendor/jquery/jquery.min.js}"></script>
<script src="vendor/popper.js/umd/popper.min.js" th:src="@{/vendor/popper.js/umd/popper.min.js}"></script>
<script src="vendor/bootstrap/js/bootstrap.min.js" th:src="@{/vendor/bootstrap/js/bootstrap.min.js}"></script>
<script src="vendor/jquery.cookie/jquery.cookie.js" th:src="@{/vendor/jquery.cookie/jquery.cookie.js}"></script>
<script src="vendor/chart.js/Chart.min.js" th:src="@{/vendor/chart.js/Chart.min.js}"></script>
<script src="vendor/jquery-validation/jquery.validate.min.js"
        th:src="@{/vendor/jquery-validation/jquery.validate.min.js}"></script>
<script src="js/charts-home.js" th:src="@{/js/charts-home.js}"></script>
<script src="js/bootstrap-table.min.js" th:src="@{/js/bootstrap-table.min.js}"></script>
<script src="js/bootstrap-table-zh-CN.min.js" th:src="@{/js/bootstrap-table-zh-CN.min.js}"></script>
<script src="js/bootstrap-datetimepicker.min.js" th:src="@{/js/bootstrap-datetimepicker.min.js}"></script>
<script src="js/bootstrap-datetimepicker.zh-CN.js" th:src="@{/js/bootstrap-datetimepicker.zh-CN.js}"></script>
<script src="js/toastr.min.js" th:src="@{/js/toastr.min.js}"></script>
<!-- Main File-->
<script src="js/front.js" th:src="@{/js/front.js}"></script>
<script th:src="@{/custom/custom.js}"></script>
<script type="text/javascript">

    $(document).on('click', '.skill-btn', function () {
        $.ajax({
            url: baseUrl + '/emp/' + $(this).attr('emp-id'),
            method: 'GET',
            success: function (result) {
                $('#skills').empty()
                // console.log(result.info.employee.skills)
                var skills = result.info.employee.skills
                if (skills != null) {
                    skills = skills.split(';')
                    for (var i in skills) {
                        var array = skills[i].split(":")
                        var skillNameTd = $('<td></td>').append(array[0])
                        var levelTd = $('<td></td>').append(array[1])
                        $('<tr></tr>').append(skillNameTd).append(levelTd).appendTo('#skills')
                    }
                }
                $('#myModal').modal()
            }
        })
    })

    $(document).on('click', '.release-btn', function () {
        // console.log($(this).parents('tr').find('td:eq(0)').text())
        var tr = $(this).parents('tr')
        $('#empId').val(tr.find('input[name="empId"]').val())
        $('#release-form').find('input[name="empName"]').val(tr.find('td:eq(0)').text())
        $('#releaseModal').modal()
    })

    $(document).on('click', '.save-btn', function () {
        $.ajax({
            url: baseUrl + '/humanConfig/',
            method: 'PUT',
            data: $('#release-form').serialize()+'&'+$.param({'projectId': $('#project-id').val()}),
            success: function () {
                window.location.href = baseUrl + '/humanConfigs/' + $('#project-id').val()
            }
        })
        $('#releaseModal').modal('hide')
    })

    $('#require-btn').click(function () {
        $.ajax({
            url: baseUrl + '/humanConfigs/employees/' + $('#project-id').val(),
            method: 'GET',
            success: function (result) {
                // console.log(result.info)
                var emps = result.info.employees
                $('#require-tbody').empty()
                for (var i = 0; i < emps.length; i++) {
                    var checkTd = $('<td></td>').append($('<input type="checkbox">').val(emps[i].id))
                    var empNameTd = $('<td></td>').append(emps[i].empName)
                    var portionTd = $('<td></td>').append($('<input type="text" class="form-control">').val(result.info.portions[i]))
                    var skillBtn = $('<button type="button" class="btn btn-sm btn-info skill-btn"></button>').append('技能信息').attr('emp-id', emps[i].id)
                    var btnTd = $('<td></td>').append(skillBtn)
                    $('<tr></tr>').append(checkTd).append(empNameTd).append(portionTd).append(btnTd).appendTo('#require-tbody')
                }
                $('#requireModal').modal()
            }
        })

    })

    $('#save-huamns').click(function () {
        // 收集复选框的id，成员名，
        var checked = $('#require-tbody').find('input:checked')
        var emps = ''
        var humanConfigs = []
        for (var i = 0; i < checked.length; i++) {
            emps += $(checked[i]).parents('tr').find('td:eq(1)').text() + ','
            // console.log($(checked[i]).parents('tr').find('td:eq(1)').text())
            var humanConfig = {}
            humanConfig.projectId = $('#project-id').val()
            humanConfig.empId = $(checked[i]).val()
            humanConfig.empName = $(checked[i]).parents('tr').find('td:eq(1)').text()
            humanConfig.portion = $(checked[i]).parents('tr').find('td:eq(2)').find('input').val()
            humanConfigs.push(humanConfig)
        }
        // console.log(humanConfigs)
        emps = emps.substr(0, emps.length - 1)
        if (confirm('确定要将[' + emps + ']加入到项目组中吗?')) {
            $.ajax({
                url: baseUrl + '/humanConfig/require',
                method: 'POST',
                data: JSON.stringify(humanConfigs),
                dataType: 'json',
                contentType: "application/json",
                success: function () {
                    window.location.href = baseUrl + '/humanConfigs/' + $('#project-id').val()
                }
            })
        }
    })

    $('#releaseModal').on('hidden.bs.modal', function () {
        $('#release-form')[0].reset() // 重置表单
        // textarea需要自己重置
        $('#releaseModal textarea[name=contribute]').text('')
    })
    $('#myModal').on('hidden.bs.modal', function () {
        //添加缺失属性
        $("body").addClass("modal-open")
    })

</script>
</body>
</html>
